<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 3: SNP QC for Imputation - ALSU Pipeline</title>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px;}
        .page-wrapper {display: flex; gap: 20px; max-width: 1400px; margin: 0 auto;}
        .sidebar {width: 250px; background: white; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); padding: 20px; height: fit-content; position: sticky; top: 20px;}
        .sidebar h3 {font-size: 1em; color: #333; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 10px;}
        .roadmap-mini {display: flex; flex-direction: column; gap: 8px;}
        .roadmap-mini a {padding: 10px 12px; background: #f5f5f5; color: #333; text-decoration: none; border-radius: 5px; border-left: 4px solid transparent; transition: all 0.3s ease; font-size: 0.9em;}
        .roadmap-mini a:hover {background: #e3f2fd; border-left-color: #667eea;}
        .roadmap-mini a.current {background: #667eea; color: white; border-left-color: #764ba2; font-weight: 600;}
        .main-content {flex: 1; background: white; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden;}
        .header {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px;}
        .back-link {color: rgba(255,255,255,0.8); text-decoration: none; margin-bottom: 15px; display: inline-block;}
        .back-link:hover {color: white;}
        .header h1 {font-size: 2em; margin-bottom: 10px;}
        .header p {opacity: 0.9;}
        .step-badge {display: inline-block; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-size: 0.9em; margin-top: 10px;}
        .content {padding: 30px;}
        .section {margin-bottom: 40px;}
        .section-header {color: #667eea; font-size: 1.5em; margin: 0 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid #667eea;}
        .section-content {line-height: 1.8; color: #555;}
        .metric-table {width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 5px; overflow: hidden; border: 1px solid #ddd;}
        .metric-table th {background: #667eea; color: white; padding: 15px; text-align: left; font-weight: 600;}
        .metric-table td {padding: 12px 15px; border-bottom: 1px solid #eee;}
        .metric-table tr:last-child td {border-bottom: none;}
        .metric-table tr:hover {background: #f9f9f9;}
        .code-block {background: #2d2d2d; color: #f8f8f2; padding: 20px; border-radius: 5px; overflow-x: auto; margin: 20px 0; font-family: 'Courier New', monospace; font-size: 0.9em; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;}
        .info-box {background: #e3f2fd; border-left: 4px solid #1976d2; padding: 15px; margin: 15px 0; border-radius: 3px;}
        .success-box {background: #e8f5e9; border-left: 4px solid #2e7d32; padding: 15px; margin: 15px 0; border-radius: 3px;}
        .stats-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;}
        .stat-card {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 5px; text-align: center;}
        .stat-value {font-size: 1.8em; font-weight: bold;}
        .stat-label {font-size: 0.85em; opacity: 0.9; margin-top: 5px;}
        .timeline {position: relative; padding: 20px 0;}
        .timeline-item {padding-left: 30px; margin: 15px 0; position: relative;}
        .timeline-item::before {content: ''; position: absolute; left: 0; top: 5px; width: 12px; height: 12px; border-radius: 50%; background: #667eea;}
        .timeline-time {color: #667eea; font-weight: bold; font-size: 0.9em;}
        .timeline-description {color: #666; margin-top: 3px;}
        .footer {background: #f5f5f5; padding: 20px 30px; text-align: center; color: #666; font-size: 0.9em; border-top: 1px solid #ddd;}
        @media (max-width: 1024px) {.page-wrapper {flex-direction: column;} .sidebar {width: 100%; position: relative; top: 0;}}
    </style>
</head>
<body>
    <div class="page-wrapper">
        <aside class="sidebar">
            <h3>Pipeline Steps</h3>
            <div class="roadmap-mini">
                <a href="step1.html">Step 1: Missingness</a>
                <a href="step2.html">Step 2: IBD Dedup</a>
                <a href="step3.html" class="current">Step 3: SNP QC</a>
                <a href="step4.html">Step 4: Imputation</a>
                <a href="step5.html">Step 5: ID Normalize</a>
                <a href="step6.html">Step 6: Final QC</a>
            </div>
        </aside>
        
        <div class="main-content">
            <div class="header">
                <a href="../index.html" class="back-link">← Back to Roadmap</a>
                <h1>Step 3: SNP Quality Control for Imputation</h1>
                <p>Filter and prepare variants for Michigan Imputation Server</p>
                <span class="step-badge">✓ Completed — December 16, 2025</span>
            </div>
            
            <div class="content">
                <div class="section">
                    <h2 class="section-header">1. Overview</h2>
                    <div class="section-content">
                        <p>
                            This step applies SNP-level quality control filters to prepare the dataset for imputation. 
                            Filters remove variants with invalid allele codes (indels), duplicate positions, and fix 
                            sample ID encoding issues (Cyrillic homoglyphs).
                        </p>
                        <div class="info-box">
                            <strong>Quality gates:</strong> Remove I/D alleles (494 variants), remove duplicates (396 variants), 
                            fix non-ASCII sample IDs (2 samples)
                        </div>
                        <h3 style="margin-top: 20px; color: #333;">Key Metrics</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">654,027</div>
                                <div class="stat-label">Starting Variants</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">890</div>
                                <div class="stat-label">Variants Removed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">473,081</div>
                                <div class="stat-label">Final Variants</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">1,098</div>
                                <div class="stat-label">Final Samples</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2 class="section-header">2. Input Data</h2>
                    <div class="section-content">
                        <table class="metric-table">
                            <tr><th>Field</th><th>Value</th></tr>
                            <tr><td><strong>Dataset Name</strong></td><td>ConvSK_mind20_dedup</td></tr>
                            <tr><td><strong>Samples</strong></td><td>1,098</td></tr>
                            <tr><td><strong>Variants</strong></td><td>654,027</td></tr>
                            <tr><td><strong>Build</strong></td><td>GRCh38 (hg38)</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="section">
                    <h2 class="section-header">3. Output Data</h2>
                    <div class="section-content">
                        <table class="metric-table">
                            <tr><th>Field</th><th>Value</th></tr>
                            <tr><td><strong>Dataset Name</strong></td><td>ConvSK_mind20_dedup_ascii (VCF format)</td></tr>
                            <tr><td><strong>Format</strong></td><td>VCF per chromosome (chr1-22.vcf.gz)</td></tr>
                            <tr><td><strong>Samples</strong></td><td>1,098</td></tr>
                            <tr><td><strong>Variants</strong></td><td>472,191 (VCF-safe biallelic SNPs)</td></tr>
                            <tr><td><strong>Quality</strong></td><td>ALT ≠ '.', no duplicate positions, ASCII sample IDs</td></tr>
                        </table>
                        <div class="success-box"><strong>✓ Quality:</strong> All variants VCF-compatible, no I/D alleles, no duplicates</div>
                    </div>
                </div>
                
                <div class="section">
                    <h2 class="section-header">4. Commands Executed</h2>
                    <div class="section-content">
                        <h3 style="color: #333; margin-top: 0;">Step 1: Identify VCF-unsafe alleles</h3>
                        <div class="code-block">$ awk '($5=="I"||$5=="D"||$6=="I"||$6=="D")' \
  ConvSK_mind20_dedup.bim | \
  wc -l

494 variants with I/D alleles</div>

                        <h3 style="color: #333; margin-top: 20px;">Step 2: Fix Cyrillic homoglyphs in sample IDs</h3>
                        <div class="code-block">$ awk 'BEGIN{OFS="\t"}
{
  new=$2
  gsub(/м/,"m",new)
  gsub(/Х/,"X",new)
  if(new!=$2) print $1,$2,$1,new
}' ConvSK_mind20_dedup.fam > update_ids_homoglyphs.txt

$ wc -l update_ids_homoglyphs.txt
2 update_ids_homoglyphs.txt</div>

                        <h3 style="color: #333; margin-top: 20px;">Step 3: Apply ID update</h3>
                        <div class="code-block">$ plink --bfile ConvSK_mind20_dedup \
  --update-ids update_ids_homoglyphs.txt \
  --make-bed \
  --out ConvSK_mind20_dedup_ascii

--update-ids: 2 people updated.
1098 people retained.</div>

                        <h3 style="color: #333; margin-top: 20px;">Step 4: Export per-chromosome VCFs</h3>
                        <div class="code-block">$ for chr in {1..22}; do
  plink --bfile ConvSK_mind20_dedup_ascii \
    --chr $chr \
    --extract vcf_ok_snps.txt \
    --recode vcf bgz \
    --out chr${chr}
  tabix -p vcf chr${chr}.vcf.gz
done

$ bcftools concat chr*.vcf.gz \
  -Oz \
  -o all_chromosomes.vcf.gz
tabix all_chromosomes.vcf.gz</div>

                        <h3 style="color: #333; margin-top: 20px;">Step 5: Remove duplicates and clean for imputation</h3>
                        <div class="code-block">$ bcftools view \
  -m2 -M2 -v snps \
  all_chromosomes.vcf.gz | \
  bcftools norm -d all \
  -Oz \
  -o michigan_ready.vcf.gz
tabix michigan_ready.vcf.gz</div>
                    </div>
                </div>
                
                <div class="section">
                    <h2 class="section-header">5. Full Chronological Log</h2>
                    <div class="section-content">
                        <div class="timeline">
                            <div class="timeline-item">
                                <div class="timeline-time">2025-12-16 08:00</div>
                                <div class="timeline-description"><strong>Identified non-VCF alleles</strong><br>Found 494 variants with I/D (insertion/deletion) alleles</div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-time">2025-12-16 08:15</div>
                                <div class="timeline-description"><strong>Fixed Cyrillic homoglyphs</strong><br>2 samples corrected: 03-25м→03-25m, 08-176Х→08-176X</div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-time">2025-12-16 08:30</div>
                                <div class="timeline-description"><strong>Exported VCF chromosomes</strong><br>Created 22 per-chromosome VCF files with ASCII-safe variants</div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-time">2025-12-16 09:00</div>
                                <div class="timeline-description"><strong>Removed duplicates</strong><br>Applied bcftools norm -d all: 396 duplicate positions removed</div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-time">2025-12-16 09:15</div>
                                <div class="timeline-description"><strong>Step 3 completed</strong><br>Generated 472,191 VCF-safe biallelic SNPs ready for Michigan server</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <a href="../index.html" style="color: #667eea; text-decoration: none;">← Back to Roadmap</a> | 
                Step 3 of 6 | Last updated: January 2, 2026
            </div>
        </div>
    </div>
</body>
</html>